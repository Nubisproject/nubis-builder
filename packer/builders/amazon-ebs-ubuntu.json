{
 "variables": {
    "git_commit_sha": "{{env `GIT_COMMIT_SHA`}}",
    "git_branch": "{{env `GIT_BRANCH`}}"
  },
   "provisioners": [
  {
    "type": "shell",
    "inline": [
      "sudo /usr/bin/apt-get update"
    ],
    "only": [ "amazon-ebs-ubuntu" ],
    "order": 1
  }
  ],
  "builders": [
  {
    "type": "amazon-ebs",
    "name": "amazon-ebs-ubuntu",
    "source_ami_filter": {
      "filters": {
        "state": "available",
        "virtualization-type": "hvm",
        "name": "{{user `source_ami_project_name_ubuntu_filter`}}"
      },
      "owners": ["{{user `source_ami_account_id_ubuntu`}}"],
      "most_recent": true
    },
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "iam_instance_profile": "{{user `iam_instance_profile`}}",
    "region": "{{user `aws_region`}}",
    "force_deregister": "{{user `force_deregister`}}",
    "force_delete_snapshot" : "{{user `force_delete_snapshot`}}",
    "instance_type": "{{user `instance_type`}}",
    "ssh_username": "{{user `ssh_username_ubuntu`}}",
    "ssh_pty": "true",
    "ami_name": "{{user `project_name`}} {{user `project_version`}} ebs ubuntu",
    "ami_description": "{{user `project_description`}}",
    "ami_regions" : "{{user `ami_regions`}}",
    "ami_groups" : "all",
    "spot_price" : "{{user `spot_price`}}",
    "spot_price_auto_product": "Linux/UNIX",
    "run_volume_tags": {
       "packer": "true"
    },
    "tags" : {
       "project": "{{user `project_name`}}",
       "version": "{{user `project_version`}}",
       "git_commit_sha": "{{user `git_commit_sha`}}",
       "git_branch": "{{user `git_branch`}}",
       "platform": "ubuntu"
    },
    "user_data": "I2Nsb3VkLWNvbmZpZwphcHRfdXBncmFkZTogZmFsc2UKYXB0X3VwZGF0ZTogZmFsc2UK"
  }
  ],
  "_user_data_comment": "Disable apt upgrade on boot via cloud-init"
}
